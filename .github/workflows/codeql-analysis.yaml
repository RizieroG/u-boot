name: CodeQL DB Analyze

on:
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout query repo
      uses: actions/checkout@v4

    - name: Download CodeQL database
      run: |
        curl -L -o u-boot-codeql.zip https://github.com/github/securitylab/releases/download/u-boot-codeql-database/u-boot_u-boot_cpp-srcVersion_d0d07ba86afc8074d79e436b1ba4478fa0f0c1b5-dist_odasa-2019-07-25-linux64.zip
        unzip u-boot-codeql.zip -d uboot-db

    - name: Download CodeQL CLI
      run: |
        curl -L -o codeql.zip https://github.com/github/codeql-cli-binaries/releases/download/v2.15.5/codeql-linux64.zip
        unzip codeql.zip -d codeql

    - name: Run custom CodeQL query
      run: |
        ./codeql/codeql database analyze \
          uboot-db \
          ./queries-static-analysis \
          --format=sarifv2.1.0 \
          --output=results.sarif

    - name: Upload results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif
